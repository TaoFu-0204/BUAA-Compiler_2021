# <center>编译技术设计文档</center>

<center>18375200 刘裕炜</center>

## 一、词法分析

### 程序架构

* `Exceptions/LexicalException.java`

  * 异常类，用于词法分析时记录遇到的错误，为后续的错误处理留下可能的接口。
  * 唯一的属性为`lineNum`，在抛出时记录当前错误行号。

* `SyntaxClasses.Token.java`

  * 38个常量，代表38种Token类型。
  * 常量数组`typeNames`，为每种类型对应的名称，输出时用。

  * 属性`type`， `int`类型，记录当前Token类型；
  * 属性`lineNo`，`int`类型，记录该Token出现的行号；
  * 属性`context`，`String`类型，记录该Token实际代表的字符串。
  * 方法`toString`，用于输出调用，输出词法分析题目所需的内容。

* `ReadFile.java`

  * 属性`fileInputStream`，`FileInputStream`类型，用于作为文件输入流；
  * 属性`filePath`，`String`类型，用于提供读入文件地址。
  * 构造方法带一个`String`类型参数，指明待读取的文本文件地址。
  * 方法`readFile()`，返回`StringBuilder`类型，用于读取代码并消除注释。

* `LexicalAnalyzer.java`

  * 属性`progranStr`，`StringBuilder`类型，为待分析的程序代码；
  * 属性`tokenList`，`Linkedlist<SyntaxClasses.Token>`类型，为处理过程中以及最后将返回的按序存储Token的链表。
  * 构造方法。
  * 方法`setProgramStr(StringBuilder programStr)`，设置`programStr`属性，即导入程序文本。
  * 方法`getTokenList()`，返回已处理好的Token链表。
  * 方法`isDigit(char c)`，判断`c`是否为0~9的数字字符。
  * 方法`isIdentNonDigit(char c)`，判断`c`是否为大小写字母或下划线。
  * 方法`isIdentChar(char c)`，判断`c`是否为Ident中允许出现的字符类型。
  * 方法`isSpace(char c)`，判断`c`是否为有效空白符。
  * 方法`lexicalAnalyze()`，执行词法分析，生成Token链表。
  * 方法`identAnalyze(int lineNum, String identStr)`，分析当前字符串是保留字还是Ident。

### 实现流程

#### 去除注释

先将整个代码扫描一遍，将所有`//`及其到行尾之间的内容，以及所有`/*`和`*/`之间的内容均替换为空格。此步去除所有注释内容。

#### 词法分析

将38种Token分为如下几类：
* 单字符类

| `+`  | `-`  | `*`  | `/`  | `%`  | `;`  | `,`  |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `(`  | `)`  | `[`  | `]`  | `{`  | `}`  |      |

该类共13种Token，每种Token均不为其它任一中Token的前缀。因此，在词法分析程序遇到该类字符时，立刻可以将其识别为相应的Token类型。

* 双字符及其前缀类

| `!`  | `>`  | `<`  | `=`  | `&`  | `|`  |
| ---- | ---- | ---- | ---- | ---- | ---- |
| `!=` | `>=` | `<=` | `==` | `&&` | `||` |

该类共6对，12种Token。可以看出，首行每个Token都是次行相应Token的前缀，因此在读取到首行的字符时，需要再尝试读取一次后面紧接着的一个字符，以确定它是单个出现还是和后面紧跟着的符号一起构成一个Token。

* 格式字符串**FormatString**

以`"`开头，以`"`结尾的字符串。在读取到一个`"`时，直接向后查找到下一个`"`字符或文件结尾。若找到下一个`"`，则两个`"`及它们之间的所有内容为一个格式字符串。若找不到，则显然有双引号不匹配，抛出错误。

* 整常数**IntConst**

全为数字的字符串。判断方法为在开头读取到一个数字字符后，将所有连续的数字字符均算入。

* 标识符和英文保留字

在排除以上所有情况之后，若读取到一个`a`-`z`，或`A`-`Z`或`-`，则一路向后读取所有`a`-`z`，`A`-`Z`，`0`-`9`或`-`。此类标识符在确定其内容后，再去尝试匹配各个英文保留字，若均无法匹配，则认为是一个标识符。

### 设计修改

* 在去除注释时，发现需要考虑`//`、`/*`、`*/`在格式字符串内的情况，因此增加了检测`"`的部分。